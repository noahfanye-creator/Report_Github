# æ¸¯è‚¡æ•°æ®æ¥å…¥æ–¹æ¡ˆ

æˆ‘å°†ä¸ºæ‚¨è®¾è®¡å®Œæ•´çš„æ¸¯è‚¡æ•°æ®æ¥å…¥ç³»ç»Ÿï¼Œæ”¯æŒä¸Aè‚¡ç»Ÿä¸€çš„æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å’Œå¯è§†åŒ–æµç¨‹ã€‚

## ä¸€ã€æ‰©å±•çš„æ•°æ®é‡‡é›†ç³»ç»Ÿï¼ˆæ”¯æŒAè‚¡+æ¸¯è‚¡ï¼‰

### 1. ç»Ÿä¸€æ•°æ®æºç®¡ç†å™¨

```python
"""
ç»Ÿä¸€å¸‚åœºæ•°æ®é‡‡é›†ç³»ç»Ÿ - æ”¯æŒAè‚¡ã€æ¸¯è‚¡ã€ç¾è‚¡
"""
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import akshare as ak
import tushare as ts
import yfinance as yf
import baostock as bs
from typing import Dict, List, Tuple, Optional, Union
import warnings
warnings.filterwarnings('ignore')

class UnifiedMarketDataSystem:
    """ç»Ÿä¸€å¸‚åœºæ•°æ®é‡‡é›†ç³»ç»Ÿï¼ˆAè‚¡ + æ¸¯è‚¡ + ç¾è‚¡ï¼‰"""
    
    def __init__(self, data_sources: List[str] = ['akshare', 'yfinance', 'tushare']):
        """
        åˆå§‹åŒ–å¤šå¸‚åœºæ•°æ®æº
        
        :param data_sources: æ•°æ®æºä¼˜å…ˆçº§åˆ—è¡¨
        """
        self.data_sources = data_sources
        self.ts_pro = None  # Tushare Proå®ä¾‹
        self.bs_login = False  # Baostockç™»å½•çŠ¶æ€
        
        # å¸‚åœºä»£ç æ˜ å°„
        self.market_mapping = {
            'Aè‚¡': ['SH', 'SZ', 'BJ', 'sh', 'sz', 'bj'],
            'æ¸¯è‚¡': ['HK', 'hk', '.HK'],
            'ç¾è‚¡': ['US', 'us', '.US']
        }
        
        self._initialize_data_sources()
    
    def _initialize_data_sources(self):
        """åˆå§‹åŒ–å„æ•°æ®æºAPI"""
        try:
            # Tushare Pro
            if 'tushare' in self.data_sources:
                ts.set_token('ä½ çš„tushare token')  # éœ€è¦ç”³è¯·
                self.ts_pro = ts.pro_api()
            
            # Baostock
            if 'baostock' in self.data_sources:
                lg = bs.login()
                if lg.error_code == '0':
                    self.bs_login = True
                    print("Baostockç™»å½•æˆåŠŸ")
                else:
                    print(f"Baostockç™»å½•å¤±è´¥: {lg.error_msg}")
                    
        except Exception as e:
            print(f"æ•°æ®æºåˆå§‹åŒ–å¤±è´¥: {e}")
    
    def get_market_data(self, 
                       symbol: str, 
                       start_date: str, 
                       end_date: str,
                       market: str = None,
                       data_type: str = 'daily',
                       adjust: str = 'hfq') -> pd.DataFrame:
        """
        è·å–å¤šå¸‚åœºè‚¡ç¥¨æ•°æ®
        
        :param symbol: è‚¡ç¥¨ä»£ç 
        :param market: å¸‚åœºç±»å‹ ('Aè‚¡', 'æ¸¯è‚¡', 'ç¾è‚¡')ï¼Œè‡ªåŠ¨æ£€æµ‹
        :param start_date: å¼€å§‹æ—¥æœŸ 'YYYY-MM-DD'
        :param end_date: ç»“æŸæ—¥æœŸ 'YYYY-MM-DD'
        :param data_type: æ•°æ®ç±»å‹ 'daily', 'weekly', 'monthly', '5min', '15min', '60min'
        :param adjust: å¤æƒç±»å‹ 'hfq'(åå¤æƒ), 'qfq'(å‰å¤æƒ), None(ä¸å¤æƒ)
        :return: æ ‡å‡†åŒ–çš„DataFrame
        """
        # è‡ªåŠ¨æ£€æµ‹å¸‚åœºç±»å‹
        if market is None:
            market = self.detect_market(symbol)
        
        print(f"è·å– {market} {symbol} æ•°æ® ({start_date} è‡³ {end_date})")
        
        data = None
        
        # æ ¹æ®ä¸åŒå¸‚åœºä½¿ç”¨ä¸åŒæ•°æ®æº
        try:
            if market == 'Aè‚¡':
                data = self._get_a_share_data(symbol, start_date, end_date, data_type, adjust)
            elif market == 'æ¸¯è‚¡':
                data = self._get_hk_share_data(symbol, start_date, end_date, data_type, adjust)
            elif market == 'ç¾è‚¡':
                data = self._get_us_share_data(symbol, start_date, end_date, data_type)
            else:
                raise ValueError(f"ä¸æ”¯æŒçš„å¸‚åœºç±»å‹: {market}")
                
        except Exception as e:
            print(f"è·å–{market}æ•°æ®å¤±è´¥: {e}")
            
            # å°è¯•å¤‡ç”¨æ•°æ®æº
            if market == 'æ¸¯è‚¡':
                print("å°è¯•ä½¿ç”¨yfinanceä½œä¸ºå¤‡ç”¨æ•°æ®æº...")
                data = self._get_hk_data_yfinance(symbol, start_date, end_date, data_type)
        
        if data is None or data.empty:
            raise ValueError(f"æ— æ³•è·å– {market} {symbol} çš„æ•°æ®")
        
        # æ•°æ®æ ‡å‡†åŒ–å¤„ç†
        data = self._standardize_data(data, symbol, market)
        
        return data
    
    def detect_market(self, symbol: str) -> str:
        """
        è‡ªåŠ¨æ£€æµ‹å¸‚åœºç±»å‹
        
        :param symbol: è‚¡ç¥¨ä»£ç 
        :return: å¸‚åœºç±»å‹ ('Aè‚¡', 'æ¸¯è‚¡', 'ç¾è‚¡')
        """
        symbol_upper = symbol.upper()
        
        # æ£€æµ‹æ¸¯è‚¡ï¼ˆå¸¸è§æ¨¡å¼ï¼‰
        hk_patterns = ['.HK', 'HK', '0', '1', '2', '3', '6', '8']  # æ¸¯è‚¡ä»£ç é€šå¸¸ä»¥0-9å¼€å¤´
        if any(pattern in symbol_upper for pattern in ['.HK', 'HK']):
            return 'æ¸¯è‚¡'
        
        # æ£€æµ‹Aè‚¡
        if any(pattern in symbol_upper for pattern in ['.SH', '.SZ', '.BJ', 'SH', 'SZ', 'BJ']):
            return 'Aè‚¡'
        if symbol_upper.startswith(('6', '0', '3', '688', '689', '8')):
            return 'Aè‚¡'
        
        # æ£€æµ‹ç¾è‚¡
        if any(pattern in symbol_upper for pattern in ['.US', '.NASDAQ', '.NYSE', 'US']):
            return 'ç¾è‚¡'
        
        # é»˜è®¤ä½¿ç”¨yfinanceæ£€æµ‹
        try:
            stock = yf.Ticker(symbol)
            info = stock.info
            if 'country' in info:
                if info['country'] == 'Hong Kong':
                    return 'æ¸¯è‚¡'
                elif info['country'] == 'United States':
                    return 'ç¾è‚¡'
                elif info['country'] == 'China':
                    return 'Aè‚¡'
        except:
            pass
        
        # é»˜è®¤è®¤ä¸ºæ˜¯æ¸¯è‚¡ï¼ˆå› ä¸ºæ¸¯è‚¡ä»£ç æ ¼å¼å¤šæ ·ï¼‰
        print(f"æ— æ³•è‡ªåŠ¨æ£€æµ‹å¸‚åœºï¼Œé»˜è®¤è§†ä¸ºæ¸¯è‚¡: {symbol}")
        return 'æ¸¯è‚¡'
    
    def _get_a_share_data(self, symbol: str, start_date: str, end_date: str,
                         data_type: str, adjust: str) -> pd.DataFrame:
        """è·å–Aè‚¡æ•°æ®"""
        data = None
        
        for source in self.data_sources:
            try:
                if source == 'akshare':
                    data = self._get_a_from_akshare(symbol, start_date, end_date, data_type, adjust)
                elif source == 'tushare' and self.ts_pro is not None:
                    data = self._get_a_from_tushare(symbol, start_date, end_date, data_type, adjust)
                elif source == 'baostock' and self.bs_login:
                    data = self._get_a_from_baostock(symbol, start_date, end_date, data_type, adjust)
                elif source == 'yfinance':
                    data = self._get_a_from_yfinance(symbol, start_date, end_date, data_type)
                
                if data is not None and not data.empty:
                    break
            except Exception as e:
                print(f"Aè‚¡æ•°æ®æº {source} å¤±è´¥: {e}")
                continue
        
        return data
    
    def _get_hk_share_data(self, symbol: str, start_date: str, end_date: str,
                          data_type: str, adjust: str) -> pd.DataFrame:
        """è·å–æ¸¯è‚¡æ•°æ®"""
        data = None
        
        # æ¸…ç†æ¸¯è‚¡ä»£ç æ ¼å¼
        hk_symbol = self._clean_hk_symbol(symbol)
        print(f"è·å–æ¸¯è‚¡æ•°æ®ï¼Œä»£ç : {hk_symbol}")
        
        for source in self.data_sources:
            try:
                if source == 'akshare':
                    data = self._get_hk_from_akshare(hk_symbol, start_date, end_date, data_type)
                elif source == 'yfinance':
                    data = self._get_hk_from_yfinance(hk_symbol, start_date, end_date, data_type)
                elif source == 'tushare' and self.ts_pro is not None:
                    data = self._get_hk_from_tushare(hk_symbol, start_date, end_date, data_type)
                
                if data is not None and not data.empty:
                    break
            except Exception as e:
                print(f"æ¸¯è‚¡æ•°æ®æº {source} å¤±è´¥: {e}")
                continue
        
        return data
    
    def _clean_hk_symbol(self, symbol: str) -> str:
        """æ¸…ç†æ¸¯è‚¡ä»£ç æ ¼å¼"""
        # ç§»é™¤ç©ºæ ¼å’Œç‚¹
        symbol = symbol.strip().replace('.', '').upper()
        
        # ç§»é™¤HKåç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
        if symbol.endswith('HK'):
            symbol = symbol[:-2]
        
        # æ¸¯è‚¡ä»£ç é€šå¸¸æ˜¯5ä½æ•°å­—ï¼Œä¸è¶³5ä½å‰é¢è¡¥0
        if symbol.isdigit() and len(symbol) < 5:
            symbol = symbol.zfill(5)
        
        return symbol
    
    def _get_hk_from_akshare(self, symbol: str, start_date: str, end_date: str,
                           data_type: str) -> pd.DataFrame:
        """ä»AKShareè·å–æ¸¯è‚¡æ•°æ®"""
        try:
            # AKShareæ¸¯è‚¡æ—¥çº¿æ•°æ®
            if data_type == 'daily':
                df = ak.stock_hk_hist(
                    symbol=symbol,
                    period="daily",
                    start_date=start_date.replace('-', ''),
                    end_date=end_date.replace('-', ''),
                    adjust=""
                )
                
                # é‡å‘½ååˆ—
                df = df.rename(columns={
                    'æ—¥æœŸ': 'date',
                    'å¼€ç›˜': 'open',
                    'æ”¶ç›˜': 'close',
                    'æœ€é«˜': 'high',
                    'æœ€ä½': 'low',
                    'æˆäº¤é‡': 'volume',
                    'æˆäº¤é¢': 'amount',
                    'æ¶¨è·Œå¹…': 'pct_change'
                })
                
                df['date'] = pd.to_datetime(df['date'])
                df.set_index('date', inplace=True)
                
                return df
                
        except Exception as e:
            print(f"AKShareæ¸¯è‚¡æ•°æ®è·å–å¤±è´¥: {e}")
            return None
    
    def _get_hk_from_yfinance(self, symbol: str, start_date: str, end_date: str,
                            data_type: str) -> pd.DataFrame:
        """ä»Yahoo Financeè·å–æ¸¯è‚¡æ•°æ®"""
        try:
            # æ·»åŠ .HKåç¼€
            yf_symbol = f"{symbol}.HK"
            
            stock = yf.Ticker(yf_symbol)
            
            if data_type == 'daily':
                df = stock.history(start=start_date, end=end_date, interval='1d')
            elif data_type == 'weekly':
                df = stock.history(start=start_date, end=end_date, interval='1wk')
            elif data_type == 'monthly':
                df = stock.history(start=start_date, end=end_date, interval='1mo')
            elif data_type == '60min':
                # è·å–æœ€è¿‘60å¤©çš„60åˆ†é’Ÿæ•°æ®
                recent_start = (datetime.strptime(end_date, '%Y-%m-%d') - 
                              timedelta(days=60)).strftime('%Y-%m-%d')
                df = stock.history(start=recent_start, end=end_date, interval='60m')
            else:
                return None
            
            # é‡å‘½ååˆ—
            df = df.rename(columns={
                'Open': 'open',
                'High': 'high',
                'Low': 'low',
                'Close': 'close',
                'Volume': 'volume'
            })
            
            # è®¡ç®—æˆäº¤é¢ï¼ˆæ¸¯å¸ï¼‰
            if 'amount' not in df.columns:
                df['amount'] = df['close'] * df['volume']
            
            return df
            
        except Exception as e:
            print(f"Yahoo Financeæ¸¯è‚¡æ•°æ®è·å–å¤±è´¥: {e}")
            return None
    
    def _get_hk_data_yfinance(self, symbol: str, start_date: str, end_date: str,
                            data_type: str) -> pd.DataFrame:
        """ä½¿ç”¨Yahoo Financeä½œä¸ºæ¸¯è‚¡å¤‡ç”¨æ•°æ®æº"""
        return self._get_hk_from_yfinance(symbol, start_date, end_date, data_type)
    
    def _get_hk_from_tushare(self, symbol: str, start_date: str, end_date: str,
                           data_type: str) -> pd.DataFrame:
        """ä»Tushareè·å–æ¸¯è‚¡æ•°æ®ï¼ˆéœ€è¦Proç‰ˆï¼‰"""
        if self.ts_pro is None:
            return None
        
        try:
            # Tushareæ¸¯è‚¡ä»£ç æ ¼å¼ï¼šè‚¡ç¥¨ä»£ç .HK
            ts_code = f"{symbol}.HK"
            
            if data_type == 'daily':
                df = self.ts_pro.hk_daily(
                    ts_code=ts_code,
                    start_date=start_date.replace('-', ''),
                    end_date=end_date.replace('-', '')
                )
                
                if df is not None and not df.empty:
                    df = df.rename(columns={
                        'trade_date': 'date',
                        'open': 'open',
                        'close': 'close',
                        'high': 'high',
                        'low': 'low',
                        'vol': 'volume',
                        'amount': 'amount'
                    })
                    
                    df['date'] = pd.to_datetime(df['date'])
                    df.set_index('date', inplace=True)
                    df.sort_index(inplace=True)
                    
                    return df
                    
        except Exception as e:
            print(f"Tushareæ¸¯è‚¡æ•°æ®è·å–å¤±è´¥: {e}")
            return None
        
        return None
    
    def _standardize_data(self, df: pd.DataFrame, symbol: str, market: str) -> pd.DataFrame:
        """
        æ ‡å‡†åŒ–æ•°æ®æ ¼å¼ï¼ˆå¤šå¸‚åœºç»Ÿä¸€ï¼‰
        
        :param df: åŸå§‹æ•°æ®
        :param symbol: è‚¡ç¥¨ä»£ç 
        :param market: å¸‚åœºç±»å‹
        :return: æ ‡å‡†åŒ–çš„DataFrame
        """
        required_columns = ['open', 'high', 'low', 'close', 'volume']
        
        # æ£€æŸ¥å¿…è¦åˆ—
        for col in required_columns:
            if col not in df.columns:
                raise ValueError(f"æ•°æ®ç¼ºå°‘å¿…è¦åˆ—: {col}")
        
        # ç¡®ä¿æ•°æ®ç±»å‹æ­£ç¡®
        numeric_columns = ['open', 'high', 'low', 'close', 'volume']
        for col in numeric_columns:
            if col in df.columns:
                df[col] = pd.to_numeric(df[col], errors='coerce')
        
        # è®¡ç®—æˆäº¤é¢ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
        if 'amount' not in df.columns:
            df['amount'] = df['close'] * df['volume']
        
        # è®¡ç®—æ¶¨è·Œå¹…
        if 'pct_change' not in df.columns:
            df['pct_change'] = df['close'].pct_change() * 100
        
        # æ·»åŠ å…ƒæ•°æ®
        df['symbol'] = symbol
        df['market'] = market
        
        # ç¡®ä¿ç´¢å¼•æ˜¯æ—¥æœŸæ—¶é—´ç±»å‹
        if not isinstance(df.index, pd.DatetimeIndex):
            df.index = pd.to_datetime(df.index)
        
        # æ’åº
        df.sort_index(inplace=True)
        
        # å»é™¤é‡å¤å’Œæ— æ•ˆæ•°æ®
        df = df[~df.index.duplicated(keep='first')]
        df = df.replace([np.inf, -np.inf], np.nan)
        df = df.dropna(subset=required_columns, how='all')
        
        # å¡«å……ç¼ºå¤±å€¼
        for col in required_columns:
            if df[col].isnull().any():
                df[col] = df[col].fillna(method='ffill').fillna(method='bfill')
        
        return df
    
    def get_multi_market_data(self, 
                            symbols: List[str],
                            start_date: str,
                            end_date: str,
                            data_type: str = 'daily') -> Dict[str, pd.DataFrame]:
        """
        æ‰¹é‡è·å–å¤šå¸‚åœºæ•°æ®
        
        :param symbols: è‚¡ç¥¨ä»£ç åˆ—è¡¨
        :param start_date: å¼€å§‹æ—¥æœŸ
        :param end_date: ç»“æŸæ—¥æœŸ
        :param data_type: æ•°æ®ç±»å‹
        :return: å­—å…¸ {è‚¡ç¥¨ä»£ç : DataFrame}
        """
        results = {}
        
        for symbol in symbols:
            try:
                data = self.get_market_data(
                    symbol=symbol,
                    start_date=start_date,
                    end_date=end_date,
                    data_type=data_type
                )
                results[symbol] = data
                print(f"âœ“ å·²è·å– {symbol}")
                
            except Exception as e:
                print(f"âœ— è·å– {symbol} å¤±è´¥: {e}")
                results[symbol] = None
        
        return results
    
    def get_hk_index_data(self, index_code: str = 'HSI',
                         start_date: str = '2020-01-01',
                         end_date: str = '2026-01-26') -> pd.DataFrame:
        """
        è·å–æ¸¯è‚¡æŒ‡æ•°æ•°æ®
        
        :param index_code: æŒ‡æ•°ä»£ç 
            HSI: æ’ç”ŸæŒ‡æ•°
            HSCEI: æ’ç”Ÿä¸­å›½ä¼ä¸šæŒ‡æ•°
            HSTECH: æ’ç”Ÿç§‘æŠ€æŒ‡æ•°
        :return: æŒ‡æ•°æ•°æ®DataFrame
        """
        index_map = {
            'HSI': '^HSI',      # æ’ç”ŸæŒ‡æ•°
            'HSCEI': '^HSCE',   # æ’ç”Ÿå›½ä¼æŒ‡æ•°
            'HSTECH': '^HSTECH' # æ’ç”Ÿç§‘æŠ€æŒ‡æ•°
        }
        
        yf_symbol = index_map.get(index_code, '^HSI')
        
        try:
            stock = yf.Ticker(yf_symbol)
            df = stock.history(start=start_date, end=end_date)
            
            df = df.rename(columns={
                'Open': 'open',
                'High': 'high',
                'Low': 'low',
                'Close': 'close',
                'Volume': 'volume'
            })
            
            df['symbol'] = index_code
            df['market'] = 'æ¸¯è‚¡æŒ‡æ•°'
            
            return df
            
        except Exception as e:
            print(f"è·å–æ¸¯è‚¡æŒ‡æ•°æ•°æ®å¤±è´¥: {e}")
            return None
```

### 2. æ¸¯è‚¡ä¸“ç”¨æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å™¨

```python
class HKMarketIndicatorCalculator:
    """
    æ¸¯è‚¡å¸‚åœºæŠ€æœ¯æŒ‡æ ‡è®¡ç®—å™¨
    åŒ…å«æ¸¯è‚¡ç‰¹æœ‰æŒ‡æ ‡å’Œè°ƒæ•´
    """
    
    def __init__(self):
        # æ¸¯è‚¡ç‰¹æœ‰å‚æ•°
        self.hk_specific_params = {
            'trading_days_per_year': 250,  # æ¸¯è‚¡å¹´äº¤æ˜“æ—¥
            'market_hours': {
                'pre_market': '09:00-09:30',
                'main_session': '09:30-12:00,13:00-16:00',
                'post_market': '16:00-17:00'
            }
        }
    
    def calculate_hk_indicators(self, data: pd.DataFrame) -> pd.DataFrame:
        """
        è®¡ç®—æ¸¯è‚¡ä¸“ç”¨æŠ€æœ¯æŒ‡æ ‡
        
        :param data: æ¸¯è‚¡æ•°æ®
        :return: åŒ…å«æ¸¯è‚¡æŒ‡æ ‡çš„æ•°æ®
        """
        df = data.copy()
        
        # åŸºç¡€æŠ€æœ¯æŒ‡æ ‡ï¼ˆä¸Aè‚¡å…±äº«ï¼‰
        base_calculator = TechnicalIndicatorCalculator(df)
        df = base_calculator.calculate_all_indicators()
        
        # æ¸¯è‚¡ç‰¹æœ‰æŒ‡æ ‡
        df = self._add_hk_specific_indicators(df)
        
        return df
    
    def _add_hk_specific_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ·»åŠ æ¸¯è‚¡ç‰¹æœ‰æŒ‡æ ‡"""
        
        # 1. æ¸¯è‚¡æ³¢åŠ¨ç‡æŒ‡æ ‡ï¼ˆè€ƒè™‘æ¸¯è‚¡æ³¢åŠ¨ç‰¹ç‚¹ï¼‰
        if 'close' in df.columns:
            returns = df['close'].pct_change()
            
            # æ¸¯è‚¡å†å²æ³¢åŠ¨ç‡ï¼ˆå¹´åŒ–ï¼‰
            df['HK_HV_20'] = returns.rolling(20).std() * np.sqrt(self.hk_specific_params['trading_days_per_year'])
            df['HK_HV_60'] = returns.rolling(60).std() * np.sqrt(self.hk_specific_params['trading_days_per_year'])
            
            # æ¸¯è‚¡æ³¢åŠ¨ç‡æŒ‡æ•°ï¼ˆæ¨¡æ‹Ÿï¼‰
            df['HK_VOL_INDEX'] = self._calculate_hk_volatility_index(returns)
        
        # 2. æ¸¯è‚¡èµ„é‡‘æµå‘æŒ‡æ ‡
        if all(col in df.columns for col in ['close', 'volume', 'amount']):
            # æ¸¯è‚¡èµ„é‡‘å‡€æµå…¥ï¼ˆç®€åŒ–ç‰ˆï¼‰
            df['HK_MONEY_FLOW'] = self._calculate_hk_money_flow(df)
            
            # æ¸¯è‚¡å¤§å•æˆäº¤æ¯”ä¾‹
            df['HK_BLOCK_TRADE_RATIO'] = self._estimate_block_trade_ratio(df)
        
        # 3. æ¸¯è‚¡ä¸Aè‚¡å…³è”æŒ‡æ ‡ï¼ˆå¦‚æœæ˜¯A+Hè‚¡ï¼‰
        df['HK_A_PREMIUM'] = np.nan  # A+Hæº¢ä»·ç‡ï¼ˆéœ€è¦Aè‚¡æ•°æ®å¯¹æ¯”ï¼‰
        
        # 4. æ¸¯è‚¡é€šèµ„é‡‘æµå‘ï¼ˆéœ€è¦é¢å¤–æ•°æ®ï¼‰
        df['HK_CONNECT_NORTH'] = np.nan  # åŒ—å‘èµ„é‡‘
        df['HK_CONNECT_SOUTH'] = np.nan  # å—å‘èµ„é‡‘
        
        return df
    
    def _calculate_hk_volatility_index(self, returns: pd.Series) -> pd.Series:
        """è®¡ç®—æ¸¯è‚¡æ³¢åŠ¨ç‡æŒ‡æ•°ï¼ˆæ¨¡æ‹Ÿï¼‰"""
        # åŸºäºå†å²æ³¢åŠ¨ç‡çš„æ³¢åŠ¨ç‡æŒ‡æ•°
        hv_20 = returns.rolling(20).std() * np.sqrt(250)
        hv_60 = returns.rolling(60).std() * np.sqrt(250)
        
        # åŠ æƒå¹³å‡
        vol_index = 0.7 * hv_20 + 0.3 * hv_60
        
        # å½’ä¸€åŒ–åˆ°0-100èŒƒå›´
        if vol_index.max() > 0:
            vol_index = (vol_index / vol_index.rolling(100).max()) * 100
        
        return vol_index
    
    def _calculate_hk_money_flow(self, df: pd.DataFrame) -> pd.Series:
        """è®¡ç®—æ¸¯è‚¡èµ„é‡‘æµå‘ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        # åŸºäºä»·æ ¼å’Œæˆäº¤é‡çš„èµ„é‡‘æµå‘è®¡ç®—
        typical_price = (df['high'] + df['low'] + df['close']) / 3
        money_flow = typical_price * df['volume']
        
        # èµ„é‡‘æµæ­£è´Ÿåˆ¤æ–­
        money_flow_positive = money_flow.copy()
        money_flow_negative = money_flow.copy()
        
        # ä»·æ ¼ä¸Šæ¶¨ä¸ºæ­£èµ„é‡‘æµï¼Œåä¹‹ä¸ºè´Ÿ
        price_change = df['close'].diff()
        money_flow_positive[price_change <= 0] = 0
        money_flow_negative[price_change > 0] = 0
        
        # èµ„é‡‘æµæ¯”ç‡
        money_flow_ratio = money_flow_positive.rolling(20).sum() / (
            money_flow_positive.rolling(20).sum() + money_flow_negative.rolling(20).sum()
        )
        
        return money_flow_ratio.fillna(0.5) * 100  # 0-100èŒƒå›´
    
    def _estimate_block_trade_ratio(self, df: pd.DataFrame) -> pd.Series:
        """ä¼°è®¡å¤§å•æˆäº¤æ¯”ä¾‹ï¼ˆåŸºäºå¼‚å¸¸æˆäº¤é‡ï¼‰"""
        # è®¡ç®—æˆäº¤é‡å¼‚å¸¸å€¼
        volume_ma = df['volume'].rolling(20).mean()
        volume_std = df['volume'].rolling(20).std()
        
        # å¤§å•å®šä¹‰ä¸ºè¶…è¿‡2å€æ ‡å‡†å·®çš„æˆäº¤é‡
        block_trade_threshold = volume_ma + 2 * volume_std
        block_trade_volume = df['volume'].copy()
        block_trade_volume[df['volume'] < block_trade_threshold] = 0
        
        # å¤§å•æ¯”ä¾‹
        block_trade_ratio = block_trade_volume / df['volume']
        
        return block_trade_ratio.fillna(0)
    
    def get_hk_market_characteristics(self, data: pd.DataFrame) -> Dict:
        """
        è·å–æ¸¯è‚¡å¸‚åœºç‰¹å¾
        
        :param data: æ¸¯è‚¡æ•°æ®
        :return: å¸‚åœºç‰¹å¾å­—å…¸
        """
        if data.empty:
            return {}
        
        characteristics = {
            'market_type': 'æ¸¯è‚¡',
            'trading_currency': 'HKD',
            'data_points': len(data),
            'price_range': {
                'min': float(data['close'].min()),
                'max': float(data['close'].max()),
                'current': float(data['close'].iloc[-1])
            },
            'volatility': {
                'daily_vol': float(data['close'].pct_change().std()),
                'annual_vol': float(data['close'].pct_change().std() * np.sqrt(250))
            },
            'liquidity': {
                'avg_volume': float(data['volume'].mean()),
                'avg_amount': float(data['amount'].mean())
            }
        }
        
        # è®¡ç®—æ¸¯è‚¡ç‰¹æœ‰ç»Ÿè®¡
        if 'HK_HV_20' in data.columns:
            characteristics['hk_specific'] = {
                'hv_20': float(data['HK_HV_20'].iloc[-1]),
                'vol_index': float(data.get('HK_VOL_INDEX', pd.Series([0])).iloc[-1]),
                'money_flow': float(data.get('HK_MONEY_FLOW', pd.Series([50])).iloc[-1])
            }
        
        return characteristics
```

### 3. å¤šå¸‚åœºå¯è§†åŒ–ç³»ç»Ÿ

```python
class MultiMarketChartRenderer:
    """
    å¤šå¸‚åœºå›¾è¡¨æ¸²æŸ“å™¨
    æ”¯æŒAè‚¡ã€æ¸¯è‚¡ç­‰ä¸åŒå¸‚åœºçš„å¯è§†åŒ–éœ€æ±‚
    """
    
    def __init__(self):
        self.colors = {
            'hk_primary': '#E74C3C',     # æ¸¯è‚¡ä¸»è‰²ï¼ˆçº¢è‰²ï¼‰
            'hk_secondary': '#C0392B',   # æ¸¯è‚¡è¾…åŠ©è‰²
            'a_primary': '#2E86AB',      # Aè‚¡ä¸»è‰²ï¼ˆè“è‰²ï¼‰
            'a_secondary': '#1A5276',    # Aè‚¡è¾…åŠ©è‰²
            'us_primary': '#27AE60',     # ç¾è‚¡ä¸»è‰²ï¼ˆç»¿è‰²ï¼‰
            'index_color': '#8E44AD'     # æŒ‡æ•°é¢œè‰²
        }
        
        self.market_styles = {
            'æ¸¯è‚¡': {
                'candle_up': '#E74C3C',  # ä¸Šæ¶¨é¢œè‰²
                'candle_down': '#27AE60', # ä¸‹è·Œé¢œè‰²
                'ma_colors': ['#FF6B6B', '#FF8E53', '#FFAA64', '#FFC785']
            },
            'Aè‚¡': {
                'candle_up': '#E74C3C',
                'candle_down': '#27AE60',
                'ma_colors': ['#2E86AB', '#45B7D1', '#73C6B6', '#95A5A6']
            },
            'ç¾è‚¡': {
                'candle_up': '#27AE60',
                'candle_down': '#E74C3C',
                'ma_colors': ['#27AE60', '#2ECC71', '#58D68D', '#82E0AA']
            }
        }
    
    def create_hk_stock_chart(self, 
                            hk_data: pd.DataFrame,
                            index_data: pd.DataFrame = None,
                            comparison_data: Dict = None,
                            save_path: str = 'hk_chart.png') -> plt.Figure:
        """
        åˆ›å»ºæ¸¯è‚¡ä¸“ä¸šåˆ†æå›¾è¡¨
        
        :param hk_data: æ¸¯è‚¡æ•°æ®
        :param index_data: æ¸¯è‚¡æŒ‡æ•°æ•°æ®ï¼ˆå¦‚æ’ç”ŸæŒ‡æ•°ï¼‰
        :param comparison_data: å¯¹æ¯”æ•°æ®ï¼ˆå¦‚Aè‚¡å¯¹æ ‡è‚¡ç¥¨ï¼‰
        :param save_path: ä¿å­˜è·¯å¾„
        :return: Matplotlib Figureå¯¹è±¡
        """
        fig = plt.figure(figsize=(18, 12))
        
        # åˆ›å»ºç½‘æ ¼å¸ƒå±€
        gs = gridspec.GridSpec(4, 3, figure=fig, 
                              height_ratios=[3, 1, 1, 1],
                              width_ratios=[3, 1, 1])
        
        # 1. æ¸¯è‚¡ä¸»å›¾ï¼ˆKçº¿ + æŒ‡æ ‡ï¼‰
        ax_main = fig.add_subplot(gs[0, 0])
        self._plot_hk_main_chart(ax_main, hk_data)
        
        # 2. æ¸¯è‚¡æˆäº¤é‡
        ax_volume = fig.add_subplot(gs[1, 0], sharex=ax_main)
        self._plot_hk_volume_chart(ax_volume, hk_data)
        
        # 3. æ¸¯è‚¡æŠ€æœ¯æŒ‡æ ‡ï¼ˆMACDï¼‰
        ax_macd = fig.add_subplot(gs[2, 0], sharex=ax_main)
        self._plot_hk_macd_chart(ax_macd, hk_data)
        
        # 4. æ¸¯è‚¡æŠ€æœ¯æŒ‡æ ‡ï¼ˆRSIï¼‰
        ax_rsi = fig.add_subplot(gs[3, 0], sharex=ax_main)
        self._plot_hk_rsi_chart(ax_rsi, hk_data)
        
        # 5. æ¸¯è‚¡æŒ‡æ•°å¯¹æ¯”ï¼ˆå¦‚æœæœ‰ï¼‰
        if index_data is not None:
            ax_index = fig.add_subplot(gs[0, 1])
            self._plot_hk_index_chart(ax_index, index_data, hk_data)
        
        # 6. æ¸¯è‚¡ç‰¹æœ‰æŒ‡æ ‡é¢æ¿
        ax_hk_panel = fig.add_subplot(gs[0, 2])
        self._plot_hk_indicator_panel(ax_hk_panel, hk_data)
        
        # 7. å¤šå¸‚åœºå¯¹æ¯”ï¼ˆå¦‚æœæœ‰ï¼‰
        if comparison_data:
            ax_comparison = fig.add_subplot(gs[1:, 1:])
            self._plot_market_comparison(ax_comparison, hk_data, comparison_data)
        
        plt.suptitle(f"æ¸¯è‚¡æŠ€æœ¯åˆ†æ - {hk_data['symbol'].iloc[0]}", fontsize=16, fontweight='bold')
        plt.tight_layout()
        
        if save_path:
            plt.savefig(save_path, dpi=300, bbox_inches='tight')
        
        return fig
    
    def _plot_hk_main_chart(self, ax, hk_data: pd.DataFrame):
        """ç»˜åˆ¶æ¸¯è‚¡ä¸»å›¾"""
        # ä½¿ç”¨æ¸¯è‚¡ç‰¹æœ‰çš„é¢œè‰²æ–¹æ¡ˆ
        style = self.market_styles.get('æ¸¯è‚¡', self.market_styles['Aè‚¡'])
        
        # ç»˜åˆ¶Kçº¿å›¾
        mpf.plot(hk_data.tail(100), type='candle', ax=ax, style='yahoo')
        
        # æ·»åŠ å‡çº¿ï¼ˆæ¸¯è‚¡å¸¸ç”¨å‡çº¿ï¼‰
        if 'MA10' in hk_data.columns:
            ax.plot(hk_data.index[-100:], hk_data['MA10'].tail(100), 
                   color=style['ma_colors'][0], label='MA10', linewidth=1.5)
        if 'MA20' in hk_data.columns:
            ax.plot(hk_data.index[-100:], hk_data['MA20'].tail(100), 
                   color=style['ma_colors'][1], label='MA20', linewidth=1.5)
        if 'MA50' in hk_data.columns:
            ax.plot(hk_data.index[-100:], hk_data['MA50'].tail(100), 
                   color=style['ma_colors'][2], label='MA50', linewidth=1.5)
        
        # å¸ƒæ—å¸¦
        if all(col in hk_data.columns for col in ['BB_upper', 'BB_lower']):
            ax.fill_between(hk_data.index[-100:], 
                          hk_data['BB_upper'].tail(100), 
                          hk_data['BB_lower'].tail(100),
                          alpha=0.2, color='gray', label='Bollinger Bands')
        
        ax.set_title('æ¸¯è‚¡ä»·æ ¼èµ°åŠ¿', fontsize=12, fontweight='bold')
        ax.set_ylabel('ä»·æ ¼ (HKD)', fontsize=10)
        ax.legend(loc='upper left', fontsize=8)
        ax.grid(True, alpha=0.3)
        
        # æ·»åŠ æ¸¯è‚¡ç‰¹æœ‰æ ‡æ³¨
        current_price = hk_data['close'].iloc[-1]
        ax.annotate(f'å½“å‰: {current_price:.2f} HKD', 
                   xy=(0.02, 0.95), xycoords='axes fraction',
                   fontsize=9, bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.8))
    
    def _plot_hk_volume_chart(self, ax, hk_data: pd.DataFrame):
        """ç»˜åˆ¶æ¸¯è‚¡æˆäº¤é‡å›¾"""
        # æ¸¯è‚¡æˆäº¤é‡é€šå¸¸è¾ƒå¤§ï¼Œä½¿ç”¨å¯¹æ•°åæ ‡
        volume_data = hk_data['volume'].tail(100)
        
        # æˆäº¤é‡é¢œè‰²ï¼ˆæ¶¨çº¢è·Œç»¿ï¼‰
        colors = ['red' if close >= open_ else 'green' 
                 for close, open_ in zip(hk_data['close'].tail(100), 
                                        hk_data['open'].tail(100))]
        
        ax.bar(hk_data.index[-100:], volume_data, color=colors, alpha=0.7, width=0.8)
        
        # æ·»åŠ æˆäº¤é‡å‡çº¿
        if 'VOL_MA20' in hk_data.columns:
            ax.plot(hk_data.index[-100:], hk_data['VOL_MA20'].tail(100), 
                   color='blue', label='VOL_MA20', linewidth=1.5)
        
        ax.set_ylabel('æˆäº¤é‡', fontsize=10)
        ax.legend(loc='upper left', fontsize=8)
        ax.grid(True, alpha=0.3)
        
        # ä½¿ç”¨å¯¹æ•°åæ ‡ï¼ˆå¦‚æœæˆäº¤é‡å˜åŒ–å¤§ï¼‰
        if volume_data.max() / volume_data.min() > 10:
            ax.set_yscale('log')
    
    def _plot_hk_macd_chart(self, ax, hk_data: pd.DataFrame):
        """ç»˜åˆ¶æ¸¯è‚¡MACDå›¾"""
        if all(col in hk_data.columns for col in ['MACD', 'MACD_signal', 'MACD_hist']):
            ax.plot(hk_data.index[-100:], hk_data['MACD'].tail(100), 
                   color='blue', label='MACD', linewidth=1.5)
            ax.plot(hk_data.index[-100:], hk_data['MACD_signal'].tail(100), 
                   color='red', label='Signal', linewidth=1.5)
            
            # MACDæŸ±çŠ¶å›¾
            ax.bar(hk_data.index[-100:], hk_data['MACD_hist'].tail(100),
                  color=['green' if x >= 0 else 'red' 
                         for x in hk_data['MACD_hist'].tail(100)],
                  alpha=0.5, width=0.8)
            
            ax.axhline(y=0, color='black', linestyle='-', linewidth=0.5)
            ax.set_ylabel('MACD', fontsize=10)
            ax.legend(loc='upper left', fontsize=8)
            ax.grid(True, alpha=0.3)
    
    def _plot_hk_rsi_chart(self, ax, hk_data: pd.DataFrame):
        """ç»˜åˆ¶æ¸¯è‚¡RSIå›¾"""
        if 'RSI' in hk_data.columns:
            ax.plot(hk_data.index[-100:], hk_data['RSI'].tail(100), 
                   color='purple', linewidth=2, label='RSI(14)')
            
            ax.axhline(y=70, color='red', linestyle='--', linewidth=1, label='è¶…ä¹°')
            ax.axhline(y=30, color='green', linestyle='--', linewidth=1, label='è¶…å–')
            ax.fill_between(hk_data.index[-100:], 30, 70, alpha=0.1, color='gray')
            
            ax.set_ylabel('RSI', fontsize=10)
            ax.set_ylim(0, 100)
            ax.legend(loc='upper left', fontsize=8)
            ax.grid(True, alpha=0.3)
            ax.set_xlabel('æ—¥æœŸ', fontsize=10)
    
    def _plot_hk_index_chart(self, ax, index_data: pd.DataFrame, hk_data: pd.DataFrame):
        """ç»˜åˆ¶æ¸¯è‚¡æŒ‡æ•°å¯¹æ¯”å›¾"""
        # å¯¹é½æ—¶é—´ç´¢å¼•
        common_index = index_data.index.intersection(hk_data.index)
        
        if len(common_index) > 0:
            # è®¡ç®—ç›¸å¯¹è¡¨ç°
            hk_price = hk_data.loc[common_index, 'close']
            index_price = index_data.loc[common_index, 'close']
            
            # å½’ä¸€åŒ–ï¼ˆä»100å¼€å§‹ï¼‰
            hk_normalized = hk_price / hk_price.iloc[0] * 100
            index_normalized = index_price / index_price.iloc[0] * 100
            
            ax.plot(common_index[-100:], hk_normalized.tail(100), 
                   color=self.colors['hk_primary'], label=hk_data['symbol'].iloc[0], linewidth=2)
            ax.plot(common_index[-100:], index_normalized.tail(100), 
                   color=self.colors['index_color'], label='æ’ç”ŸæŒ‡æ•°', linewidth=2)
            
            ax.set_title('ç›¸å¯¹æ’ç”ŸæŒ‡æ•°è¡¨ç°', fontsize=10)
            ax.set_ylabel('ç›¸å¯¹è¡¨ç° (%)', fontsize=9)
            ax.legend(loc='upper left', fontsize=8)
            ax.grid(True, alpha=0.3)
    
    def _plot_hk_indicator_panel(self, ax, hk_data: pd.DataFrame):
        """ç»˜åˆ¶æ¸¯è‚¡ç‰¹æœ‰æŒ‡æ ‡é¢æ¿"""
        ax.axis('off')
        
        latest = hk_data.iloc[-1]
        
        # æ¸¯è‚¡ç‰¹æœ‰æŒ‡æ ‡
        indicator_data = []
        
        # åŸºç¡€æŒ‡æ ‡
        indicator_data.append(["ä»·æ ¼ (HKD)", f"{latest['close']:.2f}"])
        
        if 'pct_change' in hk_data.columns:
            pct_change = hk_data['pct_change'].iloc[-1]
            color_tag = "ğŸ”´" if pct_change > 0 else "ğŸŸ¢"
            indicator_data.append(["æ—¥æ¶¨è·Œå¹…", f"{color_tag} {pct_change:+.2f}%"])
        
        # æ¸¯è‚¡ç‰¹æœ‰æŒ‡æ ‡
        if 'HK_HV_20' in hk_data.columns:
            indicator_data.append(["å†å²æ³¢åŠ¨ç‡", f"{latest['HK_HV_20']:.1f}%"])
        
        if 'HK_VOL_INDEX' in hk_data.columns:
            vol_index = latest['HK_VOL_INDEX']
            vol_status = "é«˜" if vol_index > 70 else "ä½" if vol_index < 30 else "ä¸­"
            indicator_data.append(["æ³¢åŠ¨ç‡æŒ‡æ•°", f"{vol_index:.1f} ({vol_status})"])
        
        if 'HK_MONEY_FLOW' in hk_data.columns:
            money_flow = latest['HK_MONEY_FLOW']
            flow_status = "æµå…¥" if money_flow > 60 else "æµå‡º" if money_flow < 40 else "å¹³è¡¡"
            indicator_data.append(["èµ„é‡‘æµå‘", f"{money_flow:.1f} ({flow_status})"])
        
        # æˆäº¤é‡ç›¸å…³
        if 'volume' in hk_data.columns:
            volume_ratio = latest['volume'] / hk_data['volume'].rolling(20).mean().iloc[-1]
            volume_status = "æ”¾é‡" if volume_ratio > 1.5 else "ç¼©é‡" if volume_ratio < 0.5 else "æ­£å¸¸"
            indicator_data.append(["æˆäº¤é‡", f"{volume_ratio:.1f}x ({volume_status})"])
        
        # åˆ›å»ºè¡¨æ ¼
        if indicator_data:
            table = ax.table(cellText=indicator_data,
                           cellLoc='left',
                           loc='center',
                           colWidths=[0.5, 0.5])
            
            table.auto_set_font_size(False)
            table.set_fontsize(9)
            table.scale(1, 2)
            
            # è®¾ç½®æ ·å¼
            for i in range(len(indicator_data)):
                cell = table[i, 0]
                cell.set_facecolor('#F2F3F4')
                cell.set_text_props(weight='bold')
        
        ax.set_title('æ¸¯è‚¡ç‰¹æœ‰æŒ‡æ ‡', fontsize=11, fontweight='bold', pad=20)
    
    def create_multi_market_comparison(self, 
                                     market_data: Dict[str, pd.DataFrame],
                                     save_path: str = 'market_comparison.png') -> plt.Figure:
        """
        åˆ›å»ºå¤šå¸‚åœºå¯¹æ¯”å›¾
        
        :param market_data: å­—å…¸ {å¸‚åœºæ ‡ç­¾: DataFrame}
        :param save_path: ä¿å­˜è·¯å¾„
        :return: Matplotlib Figureå¯¹è±¡
        """
        fig, axes = plt.subplots(2, 2, figsize=(16, 12))
        
        # 1. ä»·æ ¼èµ°åŠ¿å¯¹æ¯”ï¼ˆå½’ä¸€åŒ–ï¼‰
        ax1 = axes[0, 0]
        self._plot_price_comparison(ax1, market_data)
        
        # 2. æ³¢åŠ¨ç‡å¯¹æ¯”
        ax2 = axes[0, 1]
        self._plot_volatility_comparison(ax2, market_data)
        
        # 3. ç›¸å…³æ€§åˆ†æ
        ax3 = axes[1, 0]
        self._plot_correlation_analysis(ax3, market_data)
        
        # 4. ç›¸å¯¹å¼ºåº¦æŒ‡æ ‡
        ax4 = axes[1, 1]
        self._plot_relative_strength(ax4, market_data)
        
        plt.suptitle('å¤šå¸‚åœºå¯¹æ¯”åˆ†æ', fontsize=16, fontweight='bold')
        plt.tight_layout()
        
        if save_path:
            plt.savefig(save_path, dpi=300, bbox_inches='tight')
        
        return fig
    
    def _plot_price_comparison(self, ax, market_data: Dict):
        """ç»˜åˆ¶ä»·æ ¼èµ°åŠ¿å¯¹æ¯”"""
        for label, data in market_data.items():
            if data is not None and 'close' in data.columns:
                # å½’ä¸€åŒ–åˆ°100
                normalized = data['close'] / data['close'].iloc[0] * 100
                ax.plot(data.index, normalized, label=label, linewidth=2)
        
        ax.set_title('ä»·æ ¼èµ°åŠ¿å¯¹æ¯” (å½’ä¸€åŒ–)', fontsize=12)
        ax.set_ylabel('ç›¸å¯¹ä»·æ ¼ (%)', fontsize=10)
        ax.legend(loc='upper left', fontsize=9)
        ax.grid(True, alpha=0.3)
```

### 4. æ¸¯è‚¡å¢å¼ºç‰ˆæ•°æ®å‡†å¤‡æµæ°´çº¿

```python
class HKEnhancedDataPipeline:
    """
    æ¸¯è‚¡å¢å¼ºç‰ˆæ•°æ®å‡†å¤‡æµæ°´çº¿
    åŒ…å«æ¸¯è‚¡ç‰¹æœ‰æ•°æ®è·å–ã€æŒ‡æ ‡è®¡ç®—å’Œå¯è§†åŒ–
    """
    
    def __init__(self, symbol: str):
        self.symbol = symbol
        self.market = 'æ¸¯è‚¡'
        
        # åˆå§‹åŒ–å„ç»„ä»¶
        self.data_system = UnifiedMarketDataSystem(['akshare', 'yfinance'])
        self.hk_calculator = HKMarketIndicatorCalculator()
        self.chart_renderer = MultiMarketChartRenderer()
        self.validator = DataQualityValidator()
        
        self.hk_data = None
        self.index_data = None
        self.comparison_data = {}
        
    def run_complete_analysis(self,
                            start_date: str = '2025-01-01',
                            end_date: str = '2026-01-26',
                            include_index: bool = True,
                            include_comparison: List[str] = None) -> Dict:
        """
        è¿è¡Œå®Œæ•´çš„æ¸¯è‚¡åˆ†ææµç¨‹
        
        :param start_date: å¼€å§‹æ—¥æœŸ
        :param end_date: ç»“æŸæ—¥æœŸ
        :param include_index: æ˜¯å¦åŒ…å«æ¸¯è‚¡æŒ‡æ•°
        :param include_comparison: å¯¹æ¯”è‚¡ç¥¨åˆ—è¡¨
        :return: åˆ†æç»“æœå­—å…¸
        """
        print("="*60)
        print(f"å¼€å§‹æ¸¯è‚¡åˆ†æ: {self.symbol}")
        print("="*60)
        
        result = {
            'symbol': self.symbol,
            'market': self.market,
            'analysis_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        }
        
        try:
            # 1. è·å–æ¸¯è‚¡æ•°æ®
            print("1. è·å–æ¸¯è‚¡æ•°æ®...")
            self._fetch_hk_data(start_date, end_date)
            
            # 2. è·å–æ¸¯è‚¡æŒ‡æ•°æ•°æ®
            if include_index:
                print("2. è·å–æ¸¯è‚¡æŒ‡æ•°æ•°æ®...")
                self._fetch_hk_index_data(start_date, end_date)
            
            # 3. è·å–å¯¹æ¯”æ•°æ®
            if include_comparison:
                print("3. è·å–å¯¹æ¯”æ•°æ®...")
                self._fetch_comparison_data(include_comparison, start_date, end_date)
            
            # 4. éªŒè¯æ•°æ®è´¨é‡
            print("4. éªŒè¯æ•°æ®è´¨é‡...")
            quality_report = self._validate_hk_data()
            result['quality_report'] = quality_report
            
            # 5. è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
            print("5. è®¡ç®—æ¸¯è‚¡æŠ€æœ¯æŒ‡æ ‡...")
            indicators_data = self._calculate_hk_indicators()
            result.update(indicators_data)
            
            # 6. åˆ†æå¸‚åœºç‰¹å¾
            print("6. åˆ†ææ¸¯è‚¡å¸‚åœºç‰¹å¾...")
            market_characteristics = self._analyze_hk_market()
            result['market_characteristics'] = market_characteristics
            
            # 7. ç”Ÿæˆæ¸¯è‚¡å›¾è¡¨
            print("7. ç”Ÿæˆæ¸¯è‚¡åˆ†æå›¾è¡¨...")
            charts = self._generate_hk_charts()
            result['charts'] = charts
            
            # 8. å‡†å¤‡AIåˆ†ææ•°æ®
            print("8. å‡†å¤‡AIåˆ†ææ•°æ®...")
            ai_data = self._prepare_hk_ai_data(result)
            result['ai_data'] = ai_data
            
            print("\n" + "="*60)
            print("æ¸¯è‚¡åˆ†æå®Œæˆ!")
            print(f"æ•°æ®ç‚¹æ•°: {len(self.hk_data) if self.hk_data is not None else 0}")
            print(f"æ•°æ®è´¨é‡: {quality_report.get('status', 'UNKNOWN')}")
            print(f"ç”Ÿæˆå›¾è¡¨: {len(charts)}å¼ ")
            print("="*60)
            
            return result
            
        except Exception as e:
            print(f"æ¸¯è‚¡åˆ†æå¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            raise
    
    def _fetch_hk_data(self, start_date: str, end_date: str):
        """è·å–æ¸¯è‚¡æ•°æ®"""
        self.hk_data = self.data_system.get_market_data(
            symbol=self.symbol,
            market=self.market,
            start_date=start_date,
            end_date=end_date,
            data_type='daily'
        )
        
        if self.hk_data is None or self.hk_data.empty:
            raise ValueError(f"æ— æ³•è·å–æ¸¯è‚¡ {self.symbol} çš„æ•°æ®")
        
        print(f"è·å–æ¸¯è‚¡æ•°æ®æˆåŠŸ: {len(self.hk_data)} æ¡è®°å½•")
        print(f"æ—¥æœŸèŒƒå›´: {self.hk_data.index[0]} è‡³ {self.hk_data.index[-1]}")
    
    def _fetch_hk_index_data(self, start_date: str, end_date: str):
        """è·å–æ¸¯è‚¡æŒ‡æ•°æ•°æ®"""
        # è·å–æ’ç”ŸæŒ‡æ•°ä½œä¸ºåŸºå‡†
        self.index_data = self.data_system.get_hk_index_data(
            index_code='HSI',
            start_date=start_date,
            end_date=end_date
        )
        
        if self.index_data is not None:
            print(f"è·å–æ’ç”ŸæŒ‡æ•°æ•°æ®æˆåŠŸ: {len(self.index_data)} æ¡è®°å½•")
    
    def _fetch_comparison_data(self, symbols: List[str], start_date: str, end_date: str):
        """è·å–å¯¹æ¯”æ•°æ®"""
        for symbol in symbols:
            try:
                data = self.data_system.get_market_data(
                    symbol=symbol,
                    start_date=start_date,
                    end_date=end_date,
                    data_type='daily'
                )
                
                if data is not None:
                    self.comparison_data[symbol] = data
                    print(f"è·å–å¯¹æ¯”æ•°æ® {symbol} æˆåŠŸ")
                    
            except Exception as e:
                print(f"è·å–å¯¹æ¯”æ•°æ® {symbol} å¤±è´¥: {e}")
    
    def _validate_hk_data(self) -> Dict:
        """éªŒè¯æ¸¯è‚¡æ•°æ®è´¨é‡"""
        if self.hk_data is None:
            return {'status': 'FAIL', 'message': 'æ²¡æœ‰æ•°æ®'}
        
        # åŸºç¡€éªŒè¯
        base_report = self.validator.validate_ohlcv(self.hk_data)
        
        # æ¸¯è‚¡ç‰¹æœ‰éªŒè¯
        hk_report = {
            'status': base_report['status'],
            'completeness': base_report['completeness'],
            'data_points': len(self.hk_data),
            'price_range': {
                'min': float(self.hk_data['low'].min()),
                'max': float(self.hk_data['high'].max()),
                'current': float(self.hk_data['close'].iloc[-1])
            },
            'volume_analysis': {
                'avg_volume': float(self.hk_data['volume'].mean()),
                'max_volume': float(self.hk_data['volume'].max()),
                'recent_volume': float(self.hk_data['volume'].tail(5).mean())
            },
            'hk_specific_checks': self._perform_hk_specific_checks()
        }
        
        return hk_report
    
    def _perform_hk_specific_checks(self) -> Dict:
        """æ‰§è¡Œæ¸¯è‚¡ç‰¹æœ‰æ£€æŸ¥"""
        checks = {
            'price_gaps': 0,
            'volume_anomalies': 0,
            'trading_days_check': 'PASS'
        }
        
        if self.hk_data is not None:
            # æ£€æŸ¥ä»·æ ¼ç¼ºå£
            price_gaps = abs(self.hk_data['close'].pct_change()) > 0.1  # 10%ä»¥ä¸Šçš„ç¼ºå£
            checks['price_gaps'] = int(price_gaps.sum())
            
            # æ£€æŸ¥æˆäº¤é‡å¼‚å¸¸
            volume_mean = self.hk_data['volume'].mean()
            volume_std = self.hk_data['volume'].std()
            volume_anomalies = abs(self.hk_data['volume'] - volume_mean) > 3 * volume_std
            checks['volume_anomalies'] = int(volume_anomalies.sum())
            
            # æ£€æŸ¥äº¤æ˜“æ—¥æ•°é‡ï¼ˆæ¸¯è‚¡æ¯å¹´çº¦250ä¸ªäº¤æ˜“æ—¥ï¼‰
            date_range = (self.hk_data.index[-1] - self.hk_data.index[0]).days
            expected_days = date_range * 250 / 365
            actual_days = len(self.hk_data)
            
            if abs(actual_days - expected_days) / expected_days > 0.2:
                checks['trading_days_check'] = 'WARNING'
        
        return checks
    
    def _calculate_hk_indicators(self) -> Dict:
        """è®¡ç®—æ¸¯è‚¡æŠ€æœ¯æŒ‡æ ‡"""
        if self.hk_data is None:
            return {}
        
        # è®¡ç®—æ¸¯è‚¡ä¸“ç”¨æŒ‡æ ‡
        hk_with_indicators = self.hk_calculator.calculate_hk_indicators(self.hk_data)
        self.hk_data = hk_with_indicators
        
        latest = self.hk_data.iloc[-1]
        
        result = {
            'technical_indicators': {
                'trend_indicators': {
                    'MA10': float(latest.get('MA10', 0)),
                    'MA20': float(latest.get('MA20', 0)),
                    'MA50': float(latest.get('MA50', 0)),
                    'MACD': float(latest.get('MACD', 0)),
                    'MACD_signal': float(latest.get('MACD_signal', 0))
                },
                'momentum_indicators': {
                    'RSI': float(latest.get('RSI', 0)),
                    'RSI_status': 'OVERBOUGHT' if latest.get('RSI', 0) > 70 else 
                                 'OVERSOLD' if latest.get('RSI', 0) < 30 else 'NEUTRAL',
                    'STOCH_K': float(latest.get('STOCH_K', 0)),
                    'STOCH_D': float(latest.get('STOCH_D', 0))
                },
                'hk_specific_indicators': {
                    'HV_20': float(latest.get('HK_HV_20', 0)),
                    'VOL_INDEX': float(latest.get('HK_VOL_INDEX', 0)),
                    'MONEY_FLOW': float(latest.get('HK_MONEY_FLOW', 0))
                }
            },
            'price_data': self._extract_price_history(),
            'volume_analysis': self._analyze_volume_patterns()
        }
        
        return result
    
    def _extract_price_history(self) -> List[Dict]:
        """æå–ä»·æ ¼å†å²æ•°æ®"""
        if self.hk_data is None:
            return []
        
        price_history = []
        for idx, row in self.hk_data.tail(50).iterrows():
            price_history.append({
                'date': idx.strftime('%Y-%m-%d'),
                'open': float(row['open']),
                'high': float(row['high']),
                'low': float(row['low']),
                'close': float(row['close']),
                'volume': float(row['volume']),
                'pct_change': float(row.get('pct_change', 0))
            })
        
        return price_history
    
    def _analyze_volume_patterns(self) -> Dict:
        """åˆ†ææˆäº¤é‡æ¨¡å¼"""
        if self.hk_data is None:
            return {}
        
        volume_data = self.hk_data['volume']
        
        analysis = {
            'recent_avg': float(volume_data.tail(20).mean()),
            'historical_avg': float(volume_data.mean()),
            'volume_ratio': float(volume_data.tail(20).mean() / volume_data.mean()),
            'volume_trend': self._determine_volume_trend(volume_data),
            'unusual_volume_days': int((volume_data > volume_data.rolling(20).mean() * 1.5).sum())
        }
        
        return analysis
    
    def _determine_volume_trend(self, volume_series: pd.Series) -> str:
        """åˆ¤æ–­æˆäº¤é‡è¶‹åŠ¿"""
        recent_mean = volume_series.tail(5).mean()
        prev_mean = volume_series.tail(10).head(5).mean()
        
        if recent_mean > prev_mean * 1.2:
            return 'INCREASING'
        elif recent_mean < prev_mean * 0.8:
            return 'DECREASING'
        else:
            return 'STABLE'
    
    def _analyze_hk_market(self) -> Dict:
        """åˆ†ææ¸¯è‚¡å¸‚åœºç‰¹å¾"""
        if self.hk_data is None:
            return {}
        
        return self.hk_calculator.get_hk_market_characteristics(self.hk_data)
    
    def _generate_hk_charts(self) -> Dict:
        """ç”Ÿæˆæ¸¯è‚¡å›¾è¡¨"""
        charts = {}
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        try:
            # 1. æ¸¯è‚¡ä¸»åˆ†æå›¾
            main_chart_path = f"hk_main_chart_{timestamp}.png"
            self.chart_renderer.create_hk_stock_chart(
                hk_data=self.hk_data,
                index_data=self.index_data,
                comparison_data=self.comparison_data,
                save_path=main_chart_path
            )
            charts['main_chart'] = main_chart_path
            
            # 2. å¤šå¸‚åœºå¯¹æ¯”å›¾ï¼ˆå¦‚æœæœ‰å¯¹æ¯”æ•°æ®ï¼‰
            if self.comparison_data:
                comparison_chart_path = f"hk_comparison_chart_{timestamp}.png"
                
                # åˆ›å»ºåŒ…å«æ¸¯è‚¡å’Œå¯¹æ¯”æ•°æ®çš„æ•°æ®é›†
                all_market_data = {self.symbol: self.hk_data}
                all_market_data.update(self.comparison_data)
                
                self.chart_renderer.create_multi_market_comparison(
                    market_data=all_market_data,
                    save_path=comparison_chart_path
                )
                charts['comparison_chart'] = comparison_chart_path
            
            # 3. æ¸¯è‚¡æŒ‡æ ‡è¶‹åŠ¿å›¾
            indicator_chart_path = f"hk_indicator_chart_{timestamp}.png"
            self._create_hk_indicator_trend_chart(indicator_chart_path)
            charts['indicator_chart'] = indicator_chart_path
            
        except Exception as e:
            print(f"ç”Ÿæˆå›¾è¡¨å¤±è´¥: {e}")
        
        return charts
    
    def _create_hk_indicator_trend_chart(self, save_path: str):
        """åˆ›å»ºæ¸¯è‚¡æŒ‡æ ‡è¶‹åŠ¿å›¾"""
        if self.hk_data is None:
            return
        
        fig, axes = plt.subplots(3, 1, figsize=(15, 10))
        
        # 1. æ³¢åŠ¨ç‡è¶‹åŠ¿
        if 'HK_HV_20' in self.hk_data.columns:
            axes[0].plot(self.hk_data.index[-100:], self.hk_data['HK_HV_20'].tail(100),
                       color='orange', linewidth=2)
            axes[0].set_title('æ¸¯è‚¡å†å²æ³¢åŠ¨ç‡ (20æ—¥)', fontsize=12)
            axes[0].set_ylabel('æ³¢åŠ¨ç‡ (%)', fontsize=10)
            axes[0].grid(True, alpha=0.3)
        
        # 2. èµ„é‡‘æµå‘è¶‹åŠ¿
        if 'HK_MONEY_FLOW' in self.hk_data.columns:
            axes[1].plot(self.hk_data.index[-100:], self.hk_data['HK_MONEY_FLOW'].tail(100),
                       color='blue', linewidth=2)
            axes[1].axhline(y=50, color='gray', linestyle='--', alpha=0.5)
            axes[1].set_title('æ¸¯è‚¡èµ„é‡‘æµå‘æŒ‡æ ‡', fontsize=12)
            axes[1].set_ylabel('èµ„é‡‘æµå‘ (%)', fontsize=10)
            axes[1].set_ylim(0, 100)
            axes[1].grid(True, alpha=0.3)
        
        # 3. æˆäº¤é‡ä¸ä»·æ ¼å¯¹æ¯”
        if 'close' in self.hk_data.columns and 'volume' in self.hk_data.columns:
            ax2 = axes[2].twinx()
            
            # ä»·æ ¼
            axes[2].plot(self.hk_data.index[-100:], self.hk_data['close'].tail(100),
                        color='green', linewidth=2, label='ä»·æ ¼')
            axes[2].set_ylabel('ä»·æ ¼ (HKD)', fontsize=10, color='green')
            axes[2].tick_params(axis='y', labelcolor='green')
            
            # æˆäº¤é‡
            volume_normalized = self.hk_data['volume'].tail(100) / self.hk_data['volume'].tail(100).max() * 100
            ax2.bar(self.hk_data.index[-100:], volume_normalized,
                   alpha=0.3, color='gray', label='æˆäº¤é‡')
            ax2.set_ylabel('æˆäº¤é‡ (%)', fontsize=10, color='gray')
            ax2.tick_params(axis='y', labelcolor='gray')
            
            axes[2].set_title('æ¸¯è‚¡ä»·æ ¼ä¸æˆäº¤é‡å¯¹æ¯”', fontsize=12)
            axes[2].grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig(save_path, dpi=300, bbox_inches='tight')
        plt.close()
    
    def _prepare_hk_ai_data(self, analysis_result: Dict) -> Dict:
        """å‡†å¤‡æ¸¯è‚¡AIåˆ†ææ•°æ®"""
        ai_data = {
            'metadata': {
                'symbol': self.symbol,
                'market': self.market,
                'analysis_date': analysis_result['analysis_time'],
                'data_points': len(self.hk_data) if self.hk_data is not None else 0
            },
            'current_status': {
                'price': analysis_result.get('market_characteristics', {}).get('price_range', {}).get('current', 0),
                'volume': analysis_result.get('volume_analysis', {}).get('recent_avg', 0),
                'market_trend': self._determine_market_trend()
            },
            'technical_signals': analysis_result.get('technical_indicators', {}),
            'hk_specific_analysis': {
                'volatility': analysis_result.get('market_characteristics', {}).get('volatility', {}),
                'liquidity': analysis_result.get('market_characteristics', {}).get('liquidity', {}),
                'hk_indicators': analysis_result.get('technical_indicators', {}).get('hk_specific_indicators', {})
            },
            'comparison_data': self._prepare_comparison_summary()
        }
        
        # ä¿å­˜ä¸ºJSON
        json_path = f"hk_ai_data_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(json_path, 'w', encoding='utf-8') as f:
            json.dump(ai_data, f, ensure_ascii=False, indent=2)
        
        ai_data['json_path'] = json_path
        return ai_data
    
    def _determine_market_trend(self) -> str:
        """åˆ¤æ–­å¸‚åœºè¶‹åŠ¿"""
        if self.hk_data is None or len(self.hk_data) < 20:
            return 'UNKNOWN'
        
        # ä½¿ç”¨å¤šä¸ªæŒ‡æ ‡åˆ¤æ–­è¶‹åŠ¿
        close_prices = self.hk_data['close']
        
        # çŸ­æœŸè¶‹åŠ¿ï¼ˆ5æ—¥ï¼‰
        short_trend = 'UP' if close_prices.iloc[-1] > close_prices.iloc[-5] else 'DOWN'
        
        # ä¸­æœŸè¶‹åŠ¿ï¼ˆ20æ—¥ï¼‰
        ma20 = close_prices.rolling(20).mean()
        mid_trend = 'UP' if close_prices.iloc[-1] > ma20.iloc[-1] else 'DOWN'
        
        # ç»¼åˆåˆ¤æ–­
        if short_trend == 'UP' and mid_trend == 'UP':
            return 'STRONG_UP'
        elif short_trend == 'DOWN' and mid_trend == 'DOWN':
            return 'STRONG_DOWN'
        elif short_trend == 'UP':
            return 'UP'
        elif short_trend == 'DOWN':
            return 'DOWN'
        else:
            return 'SIDEWAYS'
    
    def _prepare_comparison_summary(self) -> Dict:
        """å‡†å¤‡å¯¹æ¯”æ•°æ®æ‘˜è¦"""
        summary = {}
        
        for symbol, data in self.comparison_data.items():
            if data is not None and not data.empty:
                latest = data.iloc[-1]
                summary[symbol] = {
                    'price': float(latest['close']),
                    'pct_change': float(data['close'].pct_change().iloc[-1] * 100),
                    'volume': float(latest['volume'])
                }
        
        return summary
```

### 5. å¤šå¸‚åœºåˆ†æç³»ç»Ÿé›†æˆ

```python
class MultiMarketAnalysisSystem:
    """
    å¤šå¸‚åœºåˆ†æç³»ç»Ÿ
    ç»Ÿä¸€ç®¡ç†Aè‚¡ã€æ¸¯è‚¡åˆ†æ
    """
    
    def __init__(self):
        self.data_system = UnifiedMarketDataSystem()
        self.market_pipelines = {}
        
        # æ³¨å†Œä¸åŒå¸‚åœºçš„åˆ†ææµæ°´çº¿
        self.pipeline_classes = {
            'æ¸¯è‚¡': HKEnhancedDataPipeline,
            'Aè‚¡': CompleteDataPreparationPipeline  # ä¹‹å‰å®šä¹‰çš„Aè‚¡æµæ°´çº¿
        }
    
    def analyze_stock(self, 
                     symbol: str, 
                     market: str = None,
                     start_date: str = '2025-01-01',
                     end_date: str = '2026-01-26',
                     **kwargs) -> Dict:
        """
        åˆ†ææŒ‡å®šè‚¡ç¥¨
        
        :param symbol: è‚¡ç¥¨ä»£ç 
        :param market: å¸‚åœºç±»å‹
        :param start_date: å¼€å§‹æ—¥æœŸ
        :param end_date: ç»“æŸæ—¥æœŸ
        :param kwargs: å…¶ä»–å‚æ•°ä¼ é€’ç»™æµæ°´çº¿
        :return: åˆ†æç»“æœ
        """
        # è‡ªåŠ¨æ£€æµ‹å¸‚åœº
        if market is None:
            market = self.data_system.detect_market(symbol)
        
        print(f"å¼€å§‹åˆ†æ {market} è‚¡ç¥¨: {symbol}")
        
        # è·å–å¯¹åº”çš„æµæ°´çº¿
        pipeline_class = self.pipeline_classes.get(market)
        if pipeline_class is None:
            raise ValueError(f"ä¸æ”¯æŒçš„å¸‚åœºç±»å‹: {market}")
        
        # åˆ›å»ºå¹¶è¿è¡Œæµæ°´çº¿
        pipeline = pipeline_class(symbol)
        result = pipeline.run_complete_analysis(
            start_date=start_date,
            end_date=end_date,
            **kwargs
        )
        
        # å­˜å‚¨ç»“æœ
        self.market_pipelines[symbol] = pipeline
        
        return result
    
    def analyze_multiple_stocks(self, 
                              stock_list: List[Tuple[str, str]],
                              start_date: str,
                              end_date: str) -> Dict:
        """
        æ‰¹é‡åˆ†æå¤šåªè‚¡ç¥¨
        
        :param stock_list: è‚¡ç¥¨åˆ—è¡¨ [(ä»£ç , å¸‚åœº), ...]
        :param start_date: å¼€å§‹æ—¥æœŸ
        :param end_date: ç»“æŸæ—¥æœŸ
        :return: åˆ†æç»“æœå­—å…¸
        """
        results = {}
        
        for symbol, market in stock_list:
            try:
                result = self.analyze_stock(
                    symbol=symbol,
                    market=market,
                    start_date=start_date,
                    end_date=end_date
                )
                results[symbol] = result
                
            except Exception as e:
                print(f"åˆ†æ {symbol} å¤±è´¥: {e}")
                results[symbol] = {'error': str(e)}
        
        return results
    
    def compare_markets(self, 
                       hk_symbols: List[str],
                       a_symbols: List[str],
                       start_date: str,
                       end_date: str) -> Dict:
        """
        å¯¹æ¯”æ¸¯è‚¡å’ŒAè‚¡å¸‚åœº
        
        :param hk_symbols: æ¸¯è‚¡ä»£ç åˆ—è¡¨
        :param a_symbols: Aè‚¡ä»£ç åˆ—è¡¨
        :param start_date: å¼€å§‹æ—¥æœŸ
        :param end_date: ç»“æŸæ—¥æœŸ
        :return: å¯¹æ¯”åˆ†æç»“æœ
        """
        # åˆ†ææ‰€æœ‰è‚¡ç¥¨
        all_stocks = [(s, 'æ¸¯è‚¡') for s in hk_symbols] + [(s, 'Aè‚¡') for s in a_symbols]
        
        results = self.analyze_multiple_stocks(all_stocks, start_date, end_date)
        
        # ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
        comparison_report = self._generate_market_comparison_report(results)
        
        return {
            'individual_results': results,
            'comparison_report': comparison_report
        }
    
    def _generate_market_comparison_report(self, results: Dict) -> Dict:
        """ç”Ÿæˆå¸‚åœºå¯¹æ¯”æŠ¥å‘Š"""
        report = {
            'æ¸¯è‚¡': {'count': 0, 'avg_volatility': 0, 'avg_return': 0, 'stocks': []},
            'Aè‚¡': {'count': 0, 'avg_volatility': 0, 'avg_return': 0, 'stocks': []}
        }
        
        hk_volatilities = []
        hk_returns = []
        a_volatilities = []
        a_returns = []
        
        for symbol, result in results.items():
            if 'error' in result:
                continue
            
            market = result.get('market', 'æœªçŸ¥')
            
            if market in report:
                report[market]['count'] += 1
                report[market]['stocks'].append(symbol)
                
                # æ”¶é›†æ³¢åŠ¨ç‡å’Œæ”¶ç›Šç‡æ•°æ®
                volatility = result.get('market_characteristics', {}).get('volatility', {}).get('daily_vol', 0)
                returns = result.get('price_data', [{}])[-1].get('pct_change', 0) if result.get('price_data') else 0
                
                if market == 'æ¸¯è‚¡':
                    hk_volatilities.append(volatility)
                    hk_returns.append(returns)
                elif market == 'Aè‚¡':
                    a_volatilities.append(volatility)
                    a_returns.append(returns)
        
        # è®¡ç®—å¹³å‡å€¼
        if hk_volatilities:
            report['æ¸¯è‚¡']['avg_volatility'] = np.mean(hk_volatilities)
            report['æ¸¯è‚¡']['avg_return'] = np.mean(hk_returns)
        
        if a_volatilities:
            report['Aè‚¡']['avg_volatility'] = np.mean(a_volatilities)
            report['Aè‚¡']['avg_return'] = np.mean(a_returns)
        
        return report
```

### 6. ä½¿ç”¨ç¤ºä¾‹

```python
# æ¸¯è‚¡åˆ†æä½¿ç”¨ç¤ºä¾‹
def example_hk_analysis():
    """æ¸¯è‚¡åˆ†æç¤ºä¾‹"""
    
    # 1. åˆ†æå•åªæ¸¯è‚¡
    print("ç¤ºä¾‹1: åˆ†æå•åªæ¸¯è‚¡")
    hk_pipeline = HKEnhancedDataPipeline(symbol="00700")  # è…¾è®¯æ§è‚¡
    
    result = hk_pipeline.run_complete_analysis(
        start_date="2025-06-01",
        end_date="2026-01-26",
        include_index=True,
        include_comparison=["09988", "03690"]  # é˜¿é‡Œå·´å·´ã€ç¾å›¢
    )
    
    print(f"åˆ†æå®Œæˆ!")
    print(f"- æœ€æ–°ä»·æ ¼: {result['market_characteristics']['price_range']['current']:.2f} HKD")
    print(f"- æ³¢åŠ¨ç‡: {result['market_characteristics']['volatility']['daily_vol']:.4f}")
    print(f"- ç”Ÿæˆå›¾è¡¨: {len(result['charts'])} å¼ ")
    
    # 2. ä½¿ç”¨å¤šå¸‚åœºç³»ç»Ÿ
    print("\nç¤ºä¾‹2: ä½¿ç”¨å¤šå¸‚åœºç³»ç»Ÿ")
    market_system = MultiMarketAnalysisSystem()
    
    # åˆ†ææ¸¯è‚¡å’ŒAè‚¡
    stocks_to_analyze = [
        ("00700", "æ¸¯è‚¡"),  # è…¾è®¯
        ("09988", "æ¸¯è‚¡"),  # é˜¿é‡Œå·´å·´
        ("sh688630", "Aè‚¡")  # èŠ¯ç¢å¾®è£…
    ]
    
    results = market_system.analyze_multiple_stocks(
        stock_list=stocks_to_analyze,
        start_date="2025-06-01",
        end_date="2026-01-26"
    )
    
    for symbol, result in results.items():
        if 'error' not in result:
            print(f"{symbol}: {result.get('market', 'æœªçŸ¥')} åˆ†æå®Œæˆ")
    
    # 3. å¸‚åœºå¯¹æ¯”
    print("\nç¤ºä¾‹3: å¸‚åœºå¯¹æ¯”åˆ†æ")
    comparison = market_system.compare_markets(
        hk_symbols=["00700", "09988"],
        a_symbols=["sh688630", "sh600519"],
        start_date="2025-06-01",
        end_date="2026-01-26"
    )
    
    print("å¸‚åœºå¯¹æ¯”ç»“æœ:")
    for market, data in comparison['comparison_report'].items():
        if data['count'] > 0:
            print(f"  {market}: {data['count']}åªè‚¡ç¥¨")
            print(f"    å¹³å‡æ³¢åŠ¨ç‡: {data['avg_volatility']:.4f}")
            print(f"    å¹³å‡æ”¶ç›Šç‡: {data['avg_return']:.2f}%")

# è¿è¡Œç¤ºä¾‹
if __name__ == "__main__":
    example_hk_analysis()
```

## ä¸ƒã€æ¸¯è‚¡æ•°æ®ç‰¹ç‚¹ä¸æ³¨æ„äº‹é¡¹

### 1. **æ¸¯è‚¡ç‰¹æœ‰ç‰¹å¾**
- **äº¤æ˜“æ—¶é—´**: 09:30-12:00, 13:00-16:00ï¼ˆæ¯”Aè‚¡å¤š1å°æ—¶ï¼‰
- **äº¤æ˜“è´§å¸**: æ¸¯å¸ï¼ˆHKDï¼‰
- **æ¶¨è·Œå¹…é™åˆ¶**: æ— æ¶¨è·Œå¹…é™åˆ¶ï¼ˆä½†å¸‚åœºæ³¢åŠ¨è°ƒèŠ‚æœºåˆ¶ï¼‰
- **äº¤æ˜“å•ä½**: "æ‰‹"ï¼ˆä½†æ¯æ‰‹è‚¡æ•°ä¸åŒï¼‰
- **å¸‚åœºå‚ä¸è€…**: å›½é™…æŠ•èµ„è€…æ¯”ä¾‹é«˜

### 2. **æ•°æ®è·å–å»ºè®®**
- **ä¸»æ•°æ®æº**: AKShareï¼ˆå…è´¹ï¼Œè¦†ç›–å…¨é¢ï¼‰
- **å¤‡ç”¨æ•°æ®æº**: Yahoo Financeï¼ˆå®æ—¶æ€§å¥½ï¼‰
- **ä¸“ä¸šæ•°æ®æº**: Tushare Proï¼ˆéœ€ä»˜è´¹ï¼Œæ•°æ®è´¨é‡é«˜ï¼‰

### 3. **æ¸¯è‚¡ç‰¹æœ‰æŒ‡æ ‡**
- **æ¸¯è‚¡é€šèµ„é‡‘æµ**: åŒ—å‘/å—å‘èµ„é‡‘
- **å–ç©ºæ•°æ®**: æ¸¯è‚¡æœ‰å®Œå–„çš„å–ç©ºæœºåˆ¶
- **å¤§é¢æˆäº¤**: æ¸¯è‚¡å¤§å•äº¤æ˜“æ›´å¸¸è§
- **å›½é™…å…³è”**: å—ç¾è‚¡ã€Aè‚¡å½±å“å¤§

### 4. **æŠ€æœ¯åˆ†æè°ƒæ•´**
- **æ³¢åŠ¨ç‡è®¡ç®—**: ä½¿ç”¨250ä¸ªäº¤æ˜“æ—¥ï¼ˆæ¸¯è‚¡å¹´äº¤æ˜“æ—¥ï¼‰
- **æµåŠ¨æ€§è€ƒé‡**: æ¸¯è‚¡æµåŠ¨æ€§å·®å¼‚å¤§
- **å›½é™…å› ç´ **: è€ƒè™‘æ—¶åŒºå·®å¼‚å’Œå›½é™…äº‹ä»¶å½±å“

## å…«ã€å®Œæ•´æ¸¯è‚¡åˆ†ææŠ¥å‘Šå†…å®¹

### ç”Ÿæˆçš„æŠ¥å‘ŠåŒ…æ‹¬ï¼š
1. **æ¸¯è‚¡ä¸“ç”¨å›¾è¡¨**
   - æ¸¯è‚¡ä»·æ ¼èµ°åŠ¿å›¾ï¼ˆå«æ¸¯å¸è®¡ä»·ï¼‰
   - æ’ç”ŸæŒ‡æ•°å¯¹æ¯”å›¾
   - æ¸¯è‚¡ç‰¹æœ‰æŒ‡æ ‡é¢æ¿
   - å¤šå¸‚åœºå¯¹æ¯”åˆ†æ

2. **æ¸¯è‚¡ç‰¹æœ‰æ•°æ®**
   - æ¸¯è‚¡æ³¢åŠ¨ç‡åˆ†æ
   - èµ„é‡‘æµå‘æŒ‡æ ‡
   - å¤§å•æˆäº¤åˆ†æ
   - å¸‚åœºç‰¹å¾ç»Ÿè®¡

3. **AIåˆ†ææ•°æ®**
   - ç»“æ„åŒ–æ¸¯è‚¡æ•°æ®
   - å¸‚åœºç‰¹å¾æ‘˜è¦
   - å¯¹æ¯”åˆ†æç»“æœ
   - é£é™©æç¤º

è¿™ä¸ªç³»ç»Ÿç°åœ¨å®Œå…¨æ”¯æŒæ¸¯è‚¡æ•°æ®åˆ†æï¼Œå¹¶ä¸Aè‚¡ç³»ç»Ÿæ— ç¼é›†æˆã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æµç¨‹åˆ†æAè‚¡å’Œæ¸¯è‚¡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¸‚åœºç±»å‹å¹¶åº”ç”¨ç›¸åº”çš„åˆ†ææ–¹æ³•ã€‚